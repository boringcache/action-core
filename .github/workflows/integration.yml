name: Integration Tests

on:
  push:
    branches: [main]
    paths:
      - 'action-core/**'
  pull_request:
    branches: [main]
    paths:
      - 'action-core/**'
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1'

defaults:
  run:
    working-directory: action-core

jobs:
  integration-linux:
    name: Integration (Linux ${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            arch: x64
          - runner: ubuntu-24.04-arm
            arch: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

      - name: Test CLI download
        run: |
          node -e "
            const { ensureBoringCache, isCliAvailable } = require('./dist/index.js');

            async function main() {
              console.log('Checking if CLI is available...');
              const before = await isCliAvailable();
              console.log('CLI available before:', before);

              console.log('Installing CLI...');
              await ensureBoringCache({ version: 'v1.0.0' });

              console.log('Verifying installation...');
              const after = await isCliAvailable();
              console.log('CLI available after:', after);

              if (!after) {
                throw new Error('CLI should be available after ensureBoringCache');
              }

              console.log('Integration test passed!');
            }

            main().catch(e => {
              console.error(e);
              process.exit(1);
            });
          "

      - name: Verify CLI works
        run: boringcache --version

      - name: Test tool cache (second run)
        run: |
          node -e "
            const { ensureBoringCache } = require('./dist/index.js');

            async function main() {
              console.log('Second install should use cache...');
              const start = Date.now();
              await ensureBoringCache({ version: 'v1.0.0' });
              const elapsed = Date.now() - start;
              console.log('Elapsed time:', elapsed, 'ms');

              if (elapsed > 5000) {
                console.warn('Warning: Second install took longer than expected');
              }

              console.log('Cache test passed!');
            }

            main().catch(e => {
              console.error(e);
              process.exit(1);
            });
          "

  integration-macos:
    name: Integration (macOS ARM64)
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install
        working-directory: action-core

      - name: Build
        run: npm run build
        working-directory: action-core

      - name: Test CLI download
        working-directory: action-core
        run: |
          node -e "
            const { ensureBoringCache, isCliAvailable } = require('./dist/index.js');

            async function main() {
              console.log('Installing CLI on macOS...');
              await ensureBoringCache({ version: 'v1.0.0' });

              const available = await isCliAvailable();
              if (!available) {
                throw new Error('CLI should be available after install');
              }

              console.log('macOS integration test passed!');
            }

            main().catch(e => {
              console.error(e);
              process.exit(1);
            });
          "

      - name: Verify CLI works
        run: boringcache --version

  integration-windows:
    name: Integration (Windows x64)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install
        working-directory: action-core

      - name: Build
        run: npm run build
        working-directory: action-core

      - name: Test CLI download
        working-directory: action-core
        shell: pwsh
        run: |
          node -e "
            const { ensureBoringCache, isCliAvailable } = require('./dist/index.js');

            async function main() {
              console.log('Installing CLI on Windows...');
              await ensureBoringCache({ version: 'v1.0.0' });

              const available = await isCliAvailable();
              if (!available) {
                throw new Error('CLI should be available after install');
              }

              console.log('Windows integration test passed!');
            }

            main().catch(e => {
              console.error(e);
              process.exit(1);
            });
          "

      - name: Verify CLI works
        run: boringcache --version

  integration-skip-version:
    name: Integration (skip version)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install
        working-directory: action-core

      - name: Build
        run: npm run build
        working-directory: action-core

      - name: Test skip version without CLI
        working-directory: action-core
        run: |
          node -e "
            const { ensureBoringCache } = require('./dist/index.js');

            async function main() {
              try {
                await ensureBoringCache({ version: 'skip' });
                throw new Error('Should have thrown an error');
              } catch (e) {
                if (e.message.includes('CLI not found')) {
                  console.log('Correctly threw error when CLI not available');
                } else {
                  throw e;
                }
              }
            }

            main().catch(e => {
              console.error(e);
              process.exit(1);
            });
          "

      - name: Install CLI first
        run: |
          node -e "
            const { ensureBoringCache } = require('./dist/index.js');
            ensureBoringCache({ version: 'v1.0.0' }).then(() => console.log('Installed'));
          "
        working-directory: action-core

      - name: Test skip version with CLI available
        working-directory: action-core
        run: |
          node -e "
            const { ensureBoringCache, isCliAvailable } = require('./dist/index.js');

            async function main() {
              // CLI should be available from previous step
              await ensureBoringCache({ version: 'skip' });
              console.log('Skip version test passed when CLI is available');
            }

            main().catch(e => {
              console.error(e);
              process.exit(1);
            });
          "

  integration-exec:
    name: Integration (execBoringCache)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install
        working-directory: action-core

      - name: Build
        run: npm run build
        working-directory: action-core

      - name: Test execBoringCache
        working-directory: action-core
        run: |
          node -e "
            const { ensureBoringCache, execBoringCache } = require('./dist/index.js');

            async function main() {
              await ensureBoringCache({ version: 'v1.0.0' });

              console.log('Testing execBoringCache...');
              const exitCode = await execBoringCache(['--version']);
              console.log('Exit code:', exitCode);

              if (exitCode !== 0) {
                throw new Error('Expected exit code 0');
              }

              console.log('execBoringCache test passed!');
            }

            main().catch(e => {
              console.error(e);
              process.exit(1);
            });
          "
