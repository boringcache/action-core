name: Integration Tests

on:
  push:
    branches: [main]
    paths:
      - 'lib/**'
      - 'package.json'
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1'

jobs:
  integration-linux:
    name: Integration (Linux ${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            arch: x64
          - runner: ubuntu-24.04-arm
            arch: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

      - name: Test CLI download and caching
        run: |
          node -e "
            const { ensureBoringCache, isCliAvailable } = require('./dist/index.js');

            async function main() {
              console.log('=== First install (should download) ===');
              const before = await isCliAvailable();
              console.log('CLI available before:', before);

              await ensureBoringCache({ version: 'v1.0.2' });

              const after = await isCliAvailable();
              console.log('CLI available after:', after);
              if (!after) throw new Error('CLI should be available');

              console.log('=== Second install (should use cache) ===');
              const start = Date.now();
              await ensureBoringCache({ version: 'v1.0.2' });
              console.log('Cached install took:', Date.now() - start, 'ms');

              console.log('Integration test passed!');
            }

            main().catch(e => { console.error(e); process.exit(1); });
          "

      - name: Verify CLI works
        run: boringcache --version

  integration-macos:
    name: Integration (macOS ARM64)
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install and test
        run: |
          npm install
          npm run build
          node -e "
            const { ensureBoringCache, isCliAvailable } = require('./dist/index.js');
            async function main() {
              await ensureBoringCache({ version: 'v1.0.2' });
              if (!(await isCliAvailable())) throw new Error('CLI not available');
              console.log('macOS test passed!');
            }
            main().catch(e => { console.error(e); process.exit(1); });
          "

      - name: Verify CLI
        run: boringcache --version

  integration-windows:
    name: Integration (Windows x64)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install and test
        shell: pwsh
        run: |
          npm install
          npm run build
          node -e "
            const { ensureBoringCache, isCliAvailable } = require('./dist/index.js');
            async function main() {
              await ensureBoringCache({ version: 'v1.0.2' });
              if (!(await isCliAvailable())) throw new Error('CLI not available');
              console.log('Windows test passed!');
            }
            main().catch(e => { console.error(e); process.exit(1); });
          "

      - name: Verify CLI
        run: boringcache --version

  integration-cache-disabled:
    name: Integration (cache disabled)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Test with cache disabled
        run: |
          npm install
          npm run build
          node -e "
            const { ensureBoringCache } = require('./dist/index.js');
            async function main() {
              await ensureBoringCache({ version: 'v1.0.2', cache: false });
              console.log('Cache disabled test passed!');
            }
            main().catch(e => { console.error(e); process.exit(1); });
          "
